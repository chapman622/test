<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Transport Tycoon Staff Tracker</title>
<style>
  body { font-family: sans-serif; }
  #staffBox {
    position: absolute;
    background: #222;
    color: #fff;
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 0 10px #000;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    resize: both;
    overflow: hidden;
  }
  #staffHeader {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    cursor: grab;
  }
  #staffHeader h3 { margin: 0; font-size: 16px; }
  #toggleBtn, #refreshBtn {
    padding: 3px 6px;
    cursor: pointer;
    background-color: #444;
    color: #fff;
    border: none;
    border-radius: 5px;
    font-size: 12px;
    margin-left: 2px;
  }
  #staffList { flex: 1; overflow-y: auto; }
  .staff-member { display: flex; align-items: center; padding: 5px; border-bottom: 1px solid #444; flex-direction: column; align-items: flex-start; }
  .staff-member:last-child { border-bottom: none; }
  .staff-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; }
  .staff-name { font-weight: bold; }
  .staff-time { font-size: 0.8em; color: #ccc; margin-top: 2px; }
</style>
</head>
<body>

<div id="staffBox">
  <div id="staffHeader">
    <h3>Online Staff</h3>
    <div>
      <button id="toggleBtn">−</button>
      <button id="refreshBtn">⟳</button>
    </div>
  </div>
  <div id="staffList">Loading...</div>
</div>

<script>
const serverUrl = "https://tycoon-2epova.users.cfx.re/status/widget/players.json"; 
const sessionUrl = "https://ttycoon.eu/api/v1/serverdata/sessions";
const staffListEl = document.getElementById("staffList");
const refreshBtn = document.getElementById("refreshBtn");
const toggleBtn = document.getElementById("toggleBtn");
const box = document.getElementById("staffBox");
const header = document.getElementById("staffHeader");
const headerTitle = header.querySelector("h3");

let collapsed = false;
const ROW_HEIGHT = 50;
const HEADER_HEIGHT = 40;
const PADDING = 20;
const REFRESH_INTERVAL = 5000;

// Load saved state from localStorage
const savedState = JSON.parse(localStorage.getItem("staffBoxState") || "{}");
box.style.left = savedState.left || "50px";
box.style.top = savedState.top || "50px";
box.style.width = savedState.width || "300px";
box.style.height = savedState.height || "400px";
collapsed = savedState.collapsed || false;
staffListEl.style.display = collapsed ? "none" : "block";
toggleBtn.textContent = collapsed ? '+' : '−';

// Save state helper
function saveState() {
  const state = {
    left: box.style.left,
    top: box.style.top,
    width: box.style.width,
    height: box.style.height,
    collapsed
  };
  localStorage.setItem("staffBoxState", JSON.stringify(state));
}

// Convert seconds to human readable
function formatDuration(seconds) {
  if(seconds < 60) return `${seconds}s`;
  if(seconds < 3600) return `${Math.floor(seconds/60)}m`;
  const h = Math.floor(seconds/3600);
  const m = Math.floor((seconds % 3600)/60);
  return `${h}h ${m}m`;
}

// Fetch both staff list and session times
async function fetchStaff() {
  try {
    const [playersRes, sessionsRes] = await Promise.all([
      fetch(serverUrl),
      fetch(sessionUrl)
    ]);
    const playersData = await playersRes.json();
    const sessionsData = await sessionsRes.json();

    const onlinePlayers = playersData.players;
    const staffMembers = onlinePlayers.filter(p => p[4] === true); // staff flag

    if(staffMembers.length === 0) {
      staffListEl.innerHTML = "<i>No staff online</i>";
      box.style.height = HEADER_HEIGHT + PADDING + "px";
      headerTitle.textContent = "Online Staff (0)";
      headerTitle.style.color = "red";
    } else {
      staffListEl.innerHTML = staffMembers.map(p => {
        const session = sessionsData.find(s => s.vrpId === p[2]);
        const duration = session ? formatDuration(session.sessionDuration) : "";
        return `
          <div class="staff-member">
            <div class="staff-name">${p[0]}</div>
            ${duration ? `<div class="staff-time">(${duration} online)</div>` : ''}
          </div>
        `;
      }).join("");

      let newHeight = HEADER_HEIGHT + staffMembers.length * ROW_HEIGHT + PADDING;
      newHeight = Math.min(newHeight, window.innerHeight - 50);
      newHeight = Math.max(newHeight, 100);
      box.style.height = newHeight + "px";

      headerTitle.textContent = `Online Staff (${staffMembers.length})`;
      headerTitle.style.color = "limegreen";
    }

  } catch(err) {
    staffListEl.innerHTML = "<i>Error fetching staff</i>";
    console.error(err);
    headerTitle.textContent = "Online Staff (?)";
    headerTitle.style.color = "orange";
  }
}

// Initial fetch + auto-refresh
fetchStaff();
setInterval(fetchStaff, REFRESH_INTERVAL);

// Refresh button
refreshBtn.addEventListener('click', fetchStaff);

// Toggle collapse/expand
toggleBtn.addEventListener('click', () => {
  collapsed = !collapsed;
  staffListEl.style.display = collapsed ? 'none' : 'block';
  toggleBtn.textContent = collapsed ? '+' : '−';
  saveState();
});

// Draggable
let isDragging = false, offsetX = 0, offsetY = 0;
header.addEventListener('mousedown', e => {
  isDragging = true;
  offsetX = e.clientX - box.offsetLeft;
  offsetY = e.clientY - box.offsetTop;
  header.style.cursor = 'grabbing';
});
document.addEventListener('mousemove', e => {
  if(isDragging) {
    box.style.left = (e.clientX - offsetX) + 'px';
    box.style.top = (e.clientY - offsetY) + 'px';
  }
});
document.addEventListener('mouseup', () => {
  if(isDragging) saveState();
  isDragging = false;
  header.style.cursor = 'grab';
});

// Save size changes
box.addEventListener('mouseup', saveState);
box.addEventListener('keyup', saveState);
</script>
</body>
</html>
