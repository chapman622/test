<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Transport Tycoon Staff Tracker</title>
<style>
  body { font-family: sans-serif; }
  #staffBox {
    position: absolute;
    top: 50px;
    left: 50px;
    width: 300px;
    height: 400px;
    background: #222;
    color: #fff;
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 0 10px #000;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    resize: both;
    overflow: hidden;
  }
  #staffHeader {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    cursor: grab;
  }
  #staffHeader h3 { 
    margin: 0; 
    font-size: 16px; 
    color: red;
  }
  #toggleBtn, #refreshBtn {
    padding: 3px 6px;
    cursor: pointer;
    background-color: #444;
    color: #fff;
    border: none;
    border-radius: 5px;
    font-size: 12px;
  }
  #staffList { 
    flex: 1;
    overflow-y: auto; 
  }
  .staff-member { 
    display: flex;
    align-items: center;
    padding: 5px;
    border-bottom: 1px solid #444; 
  }
  .staff-member:last-child { border-bottom: none; }
  .staff-avatar {
    width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;
  }
  .donator { color: gold; font-weight: bold; }
</style>
</head>
<body>

<div id="staffBox">
  <div id="staffHeader">
    <h3>Online Staff</h3>
    <div>
      <button id="toggleBtn">−</button>
      <button id="refreshBtn">⟳</button>
    </div>
  </div>
  <div id="staffList">Loading...</div>
</div>

<script>
const serverUrl = "https://tycoon-2epova.users.cfx.re/status/widget/players.json"; 
const staffListEl = document.getElementById("staffList");
const refreshBtn = document.getElementById("refreshBtn");
const toggleBtn = document.getElementById("toggleBtn");
const box = document.getElementById("staffBox");
const header = document.getElementById("staffHeader");

let collapsed = false;

const ROW_HEIGHT = 40;      // approximate height per staff row
const HEADER_HEIGHT = 40;   // header + buttons
const PADDING = 20;         // extra padding

// Fetch and display staff with dynamic height
async function fetchStaff() {
  try {
    const res = await fetch(serverUrl);
    const data = await res.json();
    const onlinePlayers = data.players;

    const staffMembers = onlinePlayers.filter(p => p[4] === true);

    if(staffMembers.length === 0) {
      staffListEl.innerHTML = "<i>No staff online</i>";
      box.style.height = HEADER_HEIGHT + PADDING + "px"; // shrink if none
      return;
    }

    staffListEl.innerHTML = staffMembers.map(p => `
      <div class="staff-member ${p[6] ? 'donator' : ''}">
        ${p[3] ? `<img src="${p[3]}" class="staff-avatar" />` : ''}
        ${p[0]} - ${p[5]} ${p[6] ? '(Donator)' : ''}
      </div>
    `).join("");

    // Dynamically adjust height based on staff count
    let newHeight = HEADER_HEIGHT + staffMembers.length * ROW_HEIGHT + PADDING;
    newHeight = Math.min(newHeight, window.innerHeight - 50); // max height
    newHeight = Math.max(newHeight, 100); // min height
    box.style.height = newHeight + "px";

  } catch(err) {
    staffListEl.innerHTML = "<i>Error fetching staff</i>";
    console.error(err);
  }
}

// Initial fetch + auto-update every 30s
fetchStaff();
setInterval(fetchStaff, 30000);

// Refresh button
refreshBtn.addEventListener('click', fetchStaff);

// Toggle collapse/expand
toggleBtn.addEventListener('click', () => {
  collapsed = !collapsed;
  staffListEl.style.display = collapsed ? 'none' : 'block';
  toggleBtn.textContent = collapsed ? '+' : '−';
});

// Draggable from header only
let isDragging = false, offsetX = 0, offsetY = 0;
header.addEventListener('mousedown', e => {
  isDragging = true;
  offsetX = e.clientX - box.offsetLeft;
  offsetY = e.clientY - box.offsetTop;
  header.style.cursor = 'grabbing';
});

document.addEventListener('mousemove', e => {
  if(isDragging) {
    box.style.left = (e.clientX - offsetX) + 'px';
    box.style.top = (e.clientY - offsetY) + 'px';
  }
});

document.addEventListener('mouseup', () => {
  isDragging = false;
  header.style.cursor = 'grab';
});
</script>
</body>
</html>
