<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Transport Tycoon Staff Tracker</title>
<style>
  body { font-family: sans-serif; }
  #staffBox {
    position: absolute;
    top: 50px;
    left: 50px;
    width: 300px;
    height: 400px;
    background: #222;
    color: #fff;
    padding: 10px;
    border-radius: 10px;
    box-shadow: 0 0 10px #000;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    resize: both;
    overflow: hidden;
  }
  #staffHeader {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    cursor: grab;
  }
  #staffHeader h3 { 
    margin: 0; 
    font-size: 16px; 
  }
  #toggleBtn, #refreshBtn, #simulateBtn {
    padding: 3px 6px;
    cursor: pointer;
    background-color: #444;
    color: #fff;
    border: none;
    border-radius: 5px;
    font-size: 12px;
    margin-left: 2px;
  }
  #staffList { 
    flex: 1;
    overflow-y: auto; 
  }
  .staff-member { 
    display: flex;
    align-items: center;
    padding: 5px;
    border-bottom: 1px solid #444; 
  }
  .staff-member:last-child { border-bottom: none; }
  .staff-avatar {
    width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;
  }
  .donator { color: gold; font-weight: bold; }
</style>
</head>
<body>

<div id="staffBox">
  <div id="staffHeader">
    <h3>Online Staff</h3>
    <div>
      <button id="toggleBtn">−</button>
      <button id="refreshBtn">⟳</button>
      <button id="simulateBtn">Simulate Staff</button>
    </div>
  </div>
  <div id="staffList">Loading...</div>
</div>

<script>
const serverUrl = "https://tycoon-2epova.users.cfx.re/status/widget/players.json"; 
const staffListEl = document.getElementById("staffList");
const refreshBtn = document.getElementById("refreshBtn");
const toggleBtn = document.getElementById("toggleBtn");
const simulateBtn = document.getElementById("simulateBtn");
const box = document.getElementById("staffBox");
const header = document.getElementById("staffHeader");
const headerTitle = header.querySelector("h3");

let collapsed = false;
let simulate = false;

const ROW_HEIGHT = 40;
const HEADER_HEIGHT = 40;
const PADDING = 20;
const REFRESH_INTERVAL = 5000; // 5 seconds

// Toggle simulation mode
simulateBtn.addEventListener('click', () => {
  simulate = !simulate;
  simulateBtn.textContent = simulate ? "Simulation ON" : "Simulate Staff";
  fetchStaff();
});

// Fetch staff (real or simulated)
async function fetchStaff() {
  try {
    let onlinePlayers;
    
    if(simulate) {
      onlinePlayers = Array.from({length: Math.floor(Math.random()*6)}, (_, i) => [
        `Staff${i+1}`, 100+i, 1000+i, null, true, 'Job Role', Math.random() < 0.5
      ]);
    } else {
      const res = await fetch(serverUrl);
      const data = await res.json();
      onlinePlayers = data.players;
    }

    const staffMembers = onlinePlayers.filter(p => p[4] === true);

    if(staffMembers.length === 0) {
      staffListEl.innerHTML = "<i>No staff online</i>";
      box.style.height = HEADER_HEIGHT + PADDING + "px";
      headerTitle.textContent = "Online Staff (0)";
      headerTitle.style.color = "red";
    } else {
      staffListEl.innerHTML = staffMembers.map(p => `
        <div class="staff-member ${p[6] ? 'donator' : ''}">
          ${p[3] ? `<img src="${p[3]}" class="staff-avatar" />` : ''}
          ${p[0]} - ${p[5]} ${p[6] ? '(Donator)' : ''}
        </div>
      `).join("");

      let newHeight = HEADER_HEIGHT + staffMembers.length * ROW_HEIGHT + PADDING;
      newHeight = Math.min(newHeight, window.innerHeight - 50);
      newHeight = Math.max(newHeight, 100);
      box.style.height = newHeight + "px";

      headerTitle.textContent = `Online Staff (${staffMembers.length})`;
      headerTitle.style.color = "limegreen";
    }

  } catch(err) {
    staffListEl.innerHTML = "<i>Error fetching staff</i>";
    console.error(err);
    headerTitle.textContent = "Online Staff (?)";
    headerTitle.style.color = "orange";
  }
}

// Initial fetch
fetchStaff();

// Auto-refresh for both live and simulation
setInterval(fetchStaff, REFRESH_INTERVAL);

// Refresh button
refreshBtn.addEventListener('click', fetchStaff);

// Toggle collapse/expand
toggleBtn.addEventListener('click', () => {
  collapsed = !collapsed;
  staffListEl.style.display = collapsed ? 'none' : 'block';
  toggleBtn.textContent = collapsed ? '+' : '−';
});

// Draggable from header only
let isDragging = false, offsetX = 0, offsetY = 0;
header.addEventListener('mousedown', e => {
  isDragging = true;
  offsetX = e.clientX - box.offsetLeft;
  offsetY = e.clientY - box.offsetTop;
  header.style.cursor = 'grabbing';
});

document.addEventListener('mousemove', e => {
  if(isDragging) {
    box.style.left = (e.clientX - offsetX) + 'px';
    box.style.top = (e.clientY - offsetY) + 'px';
  }
});

document.addEventListener('mouseup', () => {
  isDragging = false;
  header.style.cursor = 'grab';
});
</script>
</body>
</html>
