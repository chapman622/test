<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TT Staff Widget</title>
<style>
  #staffWidget {
    position: fixed;
    top: 50px;
    left: 50px;
    min-width: 200px;
    max-width: 90vw;
    min-height: 50px;
    background: #222;
    color: #fff;
    border-radius: 10px;
    overflow: hidden;
    font-family: Arial, sans-serif;
    user-select: none;
    box-sizing: border-box;
  }
  #staffHeader {
    background: #333;
    padding: 5px 10px;
    cursor: move;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #staffHeader h3 {
    margin: 0;
    font-size: 14px;
  }
  #staffButtons button {
    margin-left: 5px;
    background: #555;
    color: #fff;
    border: none;
    padding: 2px 5px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }
  #staffList {
    padding: 5px 10px;
    overflow-y: auto;
    max-height: 60vh;
  }
  .staff-member {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
  }
  .staff-member img {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    margin-right: 8px;
  }
  .staff-info {
    font-size: 12px;
  }
  /* Resizer */
  #resizer {
    width: 15px;
    height: 15px;
    background: transparent;
    position: absolute;
    right: 0;
    bottom: 0;
    cursor: se-resize;
  }
</style>
</head>
<body>

<div id="staffWidget">
  <div id="staffHeader">
    <h3 id="headerTitle">Online Staff (0)</h3>
    <div id="staffButtons">
      <button id="simBtn">Sim</button>
      <button id="minBtn">_</button>
      <button id="maxBtn">⬜</button>
    </div>
  </div>
  <div id="staffList"></div>
  <div id="resizer"></div>
</div>

<script>
const box = document.getElementById('staffWidget');
const header = document.getElementById('staffHeader');
const staffListEl = document.getElementById('staffList');
const headerTitle = document.getElementById('headerTitle');
const simBtn = document.getElementById('simBtn');
const minBtn = document.getElementById('minBtn');
const maxBtn = document.getElementById('maxBtn');
const resizer = document.getElementById('resizer');

let minimized = false;
let maximized = false;
let prevWidth = 250;
let prevHeight = 200;

// Draggable
let isDragging = false;
let dragOffsetX = 0;
let dragOffsetY = 0;
header.addEventListener('mousedown', (e) => {
  isDragging = true;
  dragOffsetX = e.clientX - box.offsetLeft;
  dragOffsetY = e.clientY - box.offsetTop;
});
document.addEventListener('mousemove', (e) => {
  if (isDragging) {
    box.style.left = (e.clientX - dragOffsetX) + 'px';
    box.style.top = (e.clientY - dragOffsetY) + 'px';
  }
});
document.addEventListener('mouseup', () => { isDragging = false; });

// Resizable
let isResizing = false;
resizer.addEventListener('mousedown', e => { isResizing = true; e.stopPropagation(); });
document.addEventListener('mousemove', e => {
  if(isResizing){
    box.style.width = e.clientX - box.offsetLeft + 'px';
    box.style.height = e.clientY - box.offsetTop + 'px';
  }
});
document.addEventListener('mouseup', () => { isResizing = false; });

// Minimize
minBtn.addEventListener('click', () => {
  minimized = !minimized;
  if(minimized){
    prevWidth = box.offsetWidth;
    prevHeight = box.offsetHeight;
    box.style.height = header.offsetHeight + 'px';
    box.style.width = '150px';
    staffListEl.style.display = 'none';
  } else {
    box.style.height = prevHeight + 'px';
    box.style.width = prevWidth + 'px';
    staffListEl.style.display = 'block';
  }
});

// Maximize
maxBtn.addEventListener('click', () => {
  maximized = !maximized;
  if(maximized){
    box.style.width = '90vw';
    box.style.height = '70vh';
    staffListEl.style.display = 'block';
  } else {
    box.style.width = prevWidth + 'px';
    box.style.height = prevHeight + 'px';
  }
});

// Simulated staff for testing
simBtn.addEventListener('click', () => {
  fetchStaff(true);
});

// Fetch staff
async function fetchStaff(sim=false){
  try{
    let data;
    if(sim){
      // Random 1-10 staff
      const count = Math.floor(Math.random()*10)+1;
      data = {players:[]};
      for(let i=0;i<count;i++){
        data.players.push([`Staff${i+1}`,i,1000+i,true,true,"Job"+i,false]);
      }
    } else {
      const res = await fetch('https://tycoon-2epova.users.cfx.re/status/widget/players.json');
      data = await res.json();
    }

    // Debug log
    console.log("Players fetched:");
    (data.players||[]).forEach(p => console.log(`${p[0]} → staff: ${p[4]}`));

    const staffMembers = (data.players||[]).filter(p => Array.isArray(p) && p[4]===true);

    if(staffMembers.length===0){
      staffListEl.innerHTML = "No staff online";
      headerTitle.textContent = "Online Staff (0)";
      headerTitle.style.color = "red";
      box.style.height = header.offsetHeight + 'px';
    } else {
      staffListEl.innerHTML = staffMembers.map(p => `
        <div class="staff-member">
          <img src="${p[3]||'https://via.placeholder.com/24'}">
          <div class="staff-info">${p[0]}<br><small>${p[5]}</small></div>
        </div>
      `).join("");

      const staffCount = staffMembers.length;
      const ROW_HEIGHT = 35;
      const newHeight = header.offsetHeight + staffCount*ROW_HEIGHT + 10;
      box.style.height = Math.min(newHeight, window.innerHeight-50)+'px';
      headerTitle.textContent = `Online Staff (${staffCount})`;
      headerTitle.style.color = "limegreen";

      // Auto-adjust width
      let maxTextWidth = 0;
      staffListEl.querySelectorAll('.staff-info').forEach(info=>{
        const temp = document.createElement('span');
        temp.style.visibility='hidden';
        temp.style.whiteSpace='nowrap';
        temp.style.font = window.getComputedStyle(info).font;
        temp.textContent = info.textContent;
        document.body.appendChild(temp);
        if(temp.offsetWidth>maxTextWidth) maxTextWidth=temp.offsetWidth;
        document.body.removeChild(temp);
      });
      box.style.width = Math.max(maxTextWidth+60, prevWidth)+'px';
    }
  } catch(err){
    staffListEl.innerHTML = "Error fetching staff";
    headerTitle.textContent = "Online Staff (?)";
    headerTitle.style.color = "orange";
    console.error(err);
  }
}

// Initial fetch + refresh every 10 sec
fetchStaff();
setInterval(()=>{ if(!simBtn.disabled) fetchStaff(); },10000);
</script>
</body>
</html>
