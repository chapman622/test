<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transport Tycoon Staff Widget</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #121212;
      color: white;
    }

    #staffWidget {
      position: absolute;
      top: 50px;
      left: 50px;
      width: 300px;
      min-width: 150px;
      max-width: 600px;
      height: 100px;
      background: #1e1e1e;
      color: white;
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      user-select: none;
      resize: both;
    }

    #staffHeader {
      background: #333;
      padding: 5px 10px;
      cursor: move;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
    }

    #staffList {
      padding: 5px 10px;
      overflow-y: auto;
    }

    .staffRow {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .staffRow img {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      margin-right: 5px;
    }

    #toggleBtn {
      background: transparent;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="staffWidget">
  <div id="staffHeader">
    <span id="headerTitle">Online Staff (0)</span>
    <button id="toggleBtn">−</button>
  </div>
  <div id="staffList"></div>
</div>

<script>
const box = document.getElementById("staffWidget");
const header = document.getElementById("staffHeader");
const staffListEl = document.getElementById("staffList");
const headerTitle = document.getElementById("headerTitle");
const toggleBtn = document.getElementById("toggleBtn");

let minimized = false;
let dragOffsetX = 0;
let dragOffsetY = 0;
let dragging = false;
let resizing = false;

const serverUrlBase = "https://tycoon-2epova.users.cfx.re/status/widget/players.json"; // live server URL
const HEADER_HEIGHT = 35;
const PADDING = 10;
const ROW_HEIGHT = 30;

// Dragging
header.addEventListener("mousedown", e => {
  dragging = true;
  dragOffsetX = e.clientX - box.offsetLeft;
  dragOffsetY = e.clientY - box.offsetTop;
});

document.addEventListener("mouseup", () => dragging = false);
document.addEventListener("mousemove", e => {
  if (dragging && !resizing) {
    box.style.left = (e.clientX - dragOffsetX) + "px";
    box.style.top = (e.clientY - dragOffsetY) + "px";
  }
});

// Resize from corner only
box.addEventListener("mousedown", e => {
  if (e.offsetX > box.clientWidth - 15 && e.offsetY > box.clientHeight - 15) {
    resizing = true;
  }
});
document.addEventListener("mouseup", () => resizing = false);

// Toggle minimize/maximize
toggleBtn.addEventListener("click", () => {
  minimized = !minimized;
  if (minimized) {
    box.style.height = HEADER_HEIGHT + "px";
    box.style.width = "150px";
    toggleBtn.textContent = "+";
  } else {
    updateStaffHeight(); // recalc height/width based on staff
    toggleBtn.textContent = "−";
  }
});

// Fetch and display staff
async function fetchStaff() {
  try {
    const res = await fetch(serverUrlBase);
    const data = await res.json();

    const staffMembers = (data.players || []).filter(p => Array.isArray(p) && p[4] === true);

    if (staffMembers.length === 0) {
      staffListEl.innerHTML = "No staff online";
      headerTitle.textContent = "Online Staff (0)";
      headerTitle.style.color = "red";
      box.style.height = minimized ? HEADER_HEIGHT + "px" : HEADER_HEIGHT + PADDING + "px";
      if (!minimized) box.style.width = "150px";
    } else {
      staffListEl.innerHTML = staffMembers.map(p => `
        <div class="staffRow">
          <img src="${p[3] || 'https://via.placeholder.com/24'}">
          <div>
            <div>${p[0]}</div>
            <div style="font-size:0.8em;color:#ccc">${p[5]}</div>
          </div>
        </div>
      `).join("");

      headerTitle.textContent = `Online Staff (${staffMembers.length})`;
      headerTitle.style.color = "limegreen";
      if (!minimized) updateStaffHeight(staffMembers.length);
    }
  } catch(err) {
    staffListEl.innerHTML = "Error fetching staff";
    headerTitle.textContent = "Online Staff (?)";
    headerTitle.style.color = "orange";
    console.error(err);
  }
}

// Adjust height & width based on staff
function updateStaffHeight(staffCount) {
  const count = staffCount || staffListEl.children.length;

  // Calculate max text width
  let maxTextWidth = 0;
  staffListEl.querySelectorAll(".staffRow").forEach(row => {
    const nameDiv = row.querySelector("div div:first-child");
    const jobDiv = row.querySelector("div div:last-child");
    const textWidth = nameDiv.offsetWidth + jobDiv.offsetWidth + 40; // avatar + margin
    if (textWidth > maxTextWidth) maxTextWidth = textWidth;
  });

  const newWidth = Math.min(Math.max(maxTextWidth + PADDING*2, 150), 600); // min 150, max 600
  box.style.width = minimized ? "150px" : newWidth + "px";

  const newHeight = HEADER_HEIGHT + count * ROW_HEIGHT + PADDING;
  const maxHeight = window.innerHeight - 50;
  const minHeight = 100;
  box.style.height = minimized ? HEADER_HEIGHT + "px" : Math.max(minHeight, Math.min(newHeight, maxHeight)) + "px";
}

// Auto-refresh every 10s
fetchStaff();
setInterval(fetchStaff, 10000);
</script>

</body>
</html>
