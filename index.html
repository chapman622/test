<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TT Staff Widget</title>
<style>
  body {
    margin: 0;
    background-color: white; /* page background white */
    font-family: Arial, sans-serif;
  }
  #staffWidget {
    position: absolute;
    top: 50px;
    left: 50px;
    width: 250px;
    min-width: 150px;
    background-color: #1e1e2f; /* header color */
    color: white;
    border-radius: 12px;
    overflow: hidden;
    box-sizing: border-box;
    cursor: move;
    z-index: 1000;
  }
  #staffHeader {
    background-color: #1e1e2f;
    padding: 8px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #staffHeader button {
    background: none;
    border: none;
    color: white;
    font-weight: bold;
    cursor: pointer;
    font-size: 16px;
  }
  #staffList {
    padding: 5px;
  }
  .staffRow {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
  }
  .staffRow img {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-right: 5px;
  }
  .staffName {
    font-weight: bold;
    margin-right: 5px;
  }
  .staffJob {
    font-weight: normal;
  }
  /* Resize handle */
  #staffResize {
    width: 12px;
    height: 12px;
    background: #ccc;
    position: absolute;
    bottom: 2px;
    right: 2px;
    cursor: se-resize;
  }
</style>
</head>
<body>

<div id="staffWidget">
  <div id="staffHeader">
    <span id="headerTitle">Online Staff (0)</span>
    <button id="toggleMin">−</button>
  </div>
  <div id="staffList"></div>
  <div id="staffResize"></div>
</div>

<script>
const serverUrlBase = "https://tycoon-2epova.users.cfx.re/status/widget/players.json";
const staffWidget = document.getElementById("staffWidget");
const staffListEl = document.getElementById("staffList");
const headerTitle = document.getElementById("headerTitle");
const toggleMinBtn = document.getElementById("toggleMin");
const resizeHandle = document.getElementById("staffResize");

let simActive = true;
let minimized = false;

// Drag anywhere
let isDragging = false, dragOffsetX = 0, dragOffsetY = 0;
staffWidget.addEventListener("mousedown", (e) => {
  if (e.target === resizeHandle) return;
  isDragging = true;
  dragOffsetX = e.clientX - staffWidget.offsetLeft;
  dragOffsetY = e.clientY - staffWidget.offsetTop;
});
document.addEventListener("mousemove", (e) => {
  if (isDragging) {
    staffWidget.style.left = e.clientX - dragOffsetX + "px";
    staffWidget.style.top = e.clientY - dragOffsetY + "px";
  }
});
document.addEventListener("mouseup", () => isDragging = false);

// Resize
let isResizing = false, startWidth = 0, startHeight = 0, startX = 0, startY = 0;
resizeHandle.addEventListener("mousedown", (e) => {
  e.stopPropagation();
  isResizing = true;
  startWidth = staffWidget.offsetWidth;
  startHeight = staffWidget.offsetHeight;
  startX = e.clientX;
  startY = e.clientY;
});
document.addEventListener("mousemove", (e) => {
  if (isResizing) {
    staffWidget.style.width = startWidth + (e.clientX - startX) + "px";
    staffWidget.style.height = startHeight + (e.clientY - startY) + "px";
  }
});
document.addEventListener("mouseup", () => isResizing = false);

// Minimize button
toggleMinBtn.addEventListener("click", () => {
  minimized = !minimized;
  if (minimized) {
    staffListEl.style.display = "none";
    staffWidget.style.height = "auto";
    staffWidget.style.width = "150px";
    toggleMinBtn.textContent = "+";
  } else {
    staffListEl.style.display = "block";
    toggleMinBtn.textContent = "−";
    fetchStaff(); // update height
  }
});

async function fetchStaff() {
  try {
    const res = await fetch(serverUrlBase);
    const data = await res.json();

    // Filter real staff
    const realStaff = (data.players || []).filter(p => Array.isArray(p) && p[4] === true);

    // Simulated staff
    let simStaff = [];
    if (simActive) {
      const randomCount = Math.floor(Math.random() * 20) + 1;
      for (let i = 0; i < randomCount; i++) {
        simStaff.push({ name: "SimStaff" + (i+1), job: "Job", avatar: "https://via.placeholder.com/30" });
      }
    }

    const allStaff = [...realStaff.map(p => ({
      name: p[0],
      job: p[5],
      avatar: p[3] || "https://via.placeholder.com/30"
    })), ...simStaff];

    if (allStaff.length === 0) {
      staffListEl.innerHTML = "No staff online";
      headerTitle.textContent = "Online Staff (0)";
      headerTitle.style.color = "red";
      staffWidget.style.height = "auto";
    } else {
      staffListEl.innerHTML = allStaff.map(s => `
        <div class="staffRow">
          <img src="${s.avatar}" />
          <span class="staffName">${s.name}</span>
          <span class="staffJob">${s.job}</span>
        </div>
      `).join("");
      headerTitle.textContent = `Online Staff (${allStaff.length})`;
      headerTitle.style.color = "limegreen";

      // Adjust height
      const newHeight = 40 + allStaff.length * 40 + 10;
      const maxHeight = window.innerHeight - 50;
      staffWidget.style.height = Math.min(newHeight, maxHeight) + "px";
    }
  } catch(err) {
    staffListEl.innerHTML = "Error fetching staff";
    headerTitle.textContent = "Online Staff (?)";
    headerTitle.style.color = "orange";
    console.error(err);
  }
}

// Initial fetch + auto-refresh every 10s (even if minimized)
fetchStaff();
setInterval(fetchStaff, 10000);
</script>

</body>
</html>
