<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transport Tycoon Staff Widget</title>
  <style>
    /* Only the widget is styled */
    #staffWidget {
      position: absolute;
      top: 50px;
      left: 50px;
      width: 300px;
      min-width: 150px;
      max-width: 600px;
      height: 100px;
      background: #1e1e1e;
      color: white;
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      user-select: none;
      resize: both;
      z-index: 9999;
    }

    #staffHeader {
      background: #333;
      padding: 5px 10px;
      cursor: move;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: normal; /* count not bold */
    }

    #staffList {
      padding: 5px 10px;
      overflow-y: auto;
    }

    .staffRow {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .staffRow img {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      margin-right: 5px;
    }

    /* Player name bold, job normal */
    .staffRow div div:first-child {
      font-weight: bold;
    }

    .staffRow div div:last-child {
      font-weight: normal;
      color: #ccc;
      font-size: 0.8em;
    }

    #toggleBtn {
      background: transparent;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="staffWidget">
  <div id="staffHeader">
    <span id="headerTitle">Online Staff (0)</span>
    <button id="toggleBtn">−</button>
  </div>
  <div id="staffList"></div>
</div>

<script>
const box = document.getElementById("staffWidget");
const header = document.getElementById("staffHeader");
const staffListEl = document.getElementById("staffList");
const headerTitle = document.getElementById("headerTitle");
const toggleBtn = document.getElementById("toggleBtn");

let minimized = false;
let dragOffsetX = 0;
let dragOffsetY = 0;
let dragging = false;
let resizing = false;

const serverUrlBase = "https://tycoon-2epova.users.cfx.re/status/widget/players.json"; 
const HEADER_HEIGHT = 35;
const PADDING = 10;
const ROW_HEIGHT = 30;

// Dragging
header.addEventListener("mousedown", e => {
  dragging = true;
  dragOffsetX = e.clientX - box.offsetLeft;
  dragOffsetY = e.clientY - box.offsetTop;
});

document.addEventListener("mouseup", () => dragging = false);
document.addEventListener("mousemove", e => {
  if (dragging && !resizing) {
    box.style.left = (e.clientX - dragOffsetX) + "px";
    box.style.top = (e.clientY - dragOffsetY) + "px";
  }
});

// Resize from corner only
box.addEventListener("mousedown", e => {
  if (e.offsetX > box.clientWidth - 15 && e.offsetY > box.clientHeight - 15) {
    resizing = true;
  }
});
document.addEventListener("mouseup", () => resizing = false);

// Toggle minimize/maximize
toggleBtn.addEventListener("click", () => {
  minimized = !minimized;
  if (minimized) {
    box.style.height = HEADER_HEIGHT + "px";
    box.style.width = "150px";
    toggleBtn.textContent = "+";
  } else {
    updateStaffHeightAndWidth(); 
    toggleBtn.textContent = "−";
  }
});

// Fetch and display staff
async function fetchStaff() {
  try {
    const res = await fetch(serverUrlBase);
    const data = await res.json();

    const staffMembers = (data.players || []).filter(p => Array.isArray(p) && p[4] === true);

    if (staffMembers.length === 0) {
      staffListEl.innerHTML = "No staff online";
      headerTitle.textContent = "Online Staff (0)";
      headerTitle.style.color = "red";
      box.style.height = minimized ? HEADER_HEIGHT + "px" : HEADER_HEIGHT + PADDING + "px";
      if (!minimized) box.style.width = "150px";
    } else {
      staffListEl.innerHTML = staffMembers.map(p => `
        <div class="staffRow">
          <img src="${p[3] || 'https://via.placeholder.com/24'}">
          <div>
            <div>${p[0]}</div>
            <div>${p[5]}</div>
          </div>
        </div>
      `).join("");

      headerTitle.textContent = `Online Staff (${staffMembers.length})`;
      headerTitle.style.color = "limegreen";
      if (!minimized) updateStaffHeightAndWidth();
    }
  } catch(err) {
    staffListEl.innerHTML = "Error fetching staff";
    headerTitle.textContent = "Online Staff (?)";
    headerTitle.style.color = "orange";
    console.error(err);
  }
}

// Adjust height & auto width based on staff names/jobs
function updateStaffHeightAndWidth() {
  const count = staffListEl.children.length;

  // Calculate width based on longest name + job
  let maxTextWidth = 0;
  const tempDiv = document.createElement("div");
  tempDiv.style.position = "absolute";
  tempDiv.style.visibility = "hidden";
  tempDiv.style.whiteSpace = "nowrap";
  tempDiv.style.fontWeight = "bold";
  document.body.appendChild(tempDiv);

  staffListEl.querySelectorAll(".staffRow").forEach(row => {
    const name = row.querySelector("div div:first-child").textContent;
    const job = row.querySelector("div div:last-child").textContent;
    tempDiv.style.fontWeight = "bold";
    tempDiv.textContent = name;
    const nameWidth = tempDiv.offsetWidth;
    tempDiv.style.fontWeight = "normal";
    tempDiv.textContent = job;
    const jobWidth = tempDiv.offsetWidth;
    const total = nameWidth + jobWidth + 40; // + avatar/margin
    if (total > maxTextWidth) maxTextWidth = total;
  });

  document.body.removeChild(tempDiv);

  const newWidth = Math.min(Math.max(maxTextWidth + PADDING*2, 150), 600); 
  box.style.width = minimized ? "150px" : newWidth + "px";

  const newHeight = HEADER_HEIGHT + count * ROW_HEIGHT + PADDING;
  const maxHeight = window.innerHeight - 50;
  const minHeight = 100;
  box.style.height = minimized ? HEADER_HEIGHT + "px" : Math.max(minHeight, Math.min(newHeight, maxHeight)) + "px";
}

// Auto-refresh every 10s
fetchStaff();
setInterval(fetchStaff, 10000);
</script>

</body>
</html>
