<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TT Staff Widget</title>
<style>
  body {
    background: #fff; /* webpage background white */
    font-family: Arial, sans-serif;
  }

  #staffWidget {
    position: fixed;
    top: 50px;
    left: 50px;
    width: 300px;
    min-width: 200px;
    max-width: 600px;
    background: #333; /* same as header */
    color: #fff;
    border-radius: 10px;
    overflow: hidden;
    z-index: 9999;
    resize: both;
    padding: 5px;
    box-sizing: border-box;
    cursor: move;
  }

  #staffHeader {
    background: #333;
    color: #fff;
    padding: 5px 10px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: move;
  }

  #staffList {
    margin-top: 5px;
  }

  #staffList div {
    display: flex;
    align-items: center;
    margin: 3px 0;
  }

  #staffList div span.name {
    color: #fff;
    font-weight: bold;
    margin-left: 5px;
  }

  #staffList div span.job {
    color: #fff;
    font-weight: normal;
    margin-left: 5px;
  }

  #staffList div img {
    width: 30px;
    height: 30px;
    border-radius: 50%;
  }

  .minimized #staffList {
    display: none;
  }
</style>
</head>
<body>

<div id="staffWidget">
  <div id="staffHeader">
    <span id="headerTitle">Online Staff (0)</span>
    <button id="minMaxBtn">-</button>
  </div>
  <div id="staffList"></div>
  <button id="simBtn">Sim Staff</button>
</div>

<script>
const box = document.getElementById("staffWidget");
const header = document.getElementById("staffHeader");
const staffListEl = document.getElementById("staffList");
const headerButton = document.getElementById("minMaxBtn");
const simBtn = document.getElementById("simBtn");
const serverUrlBase = "https://tycoon-2epova.users.cfx.re/status/widget/players.json";

const HEADER_HEIGHT = 30;
const ROW_HEIGHT = 35;
const PADDING = 10;

let simActive = false;
let simStaffCount = 0;

// Dragging
let isDragging = false;
let dragOffsetX, dragOffsetY;
box.addEventListener("mousedown", e => {
  if (e.target !== headerButton && e.target !== simBtn) {
    isDragging = true;
    dragOffsetX = e.clientX - box.offsetLeft;
    dragOffsetY = e.clientY - box.offsetTop;
  }
});
document.addEventListener("mouseup", () => isDragging = false);
document.addEventListener("mousemove", e => {
  if (isDragging) {
    box.style.left = (e.clientX - dragOffsetX) + "px";
    box.style.top = (e.clientY - dragOffsetY) + "px";
  }
});

// Minimize / Maximize
headerButton.addEventListener("click", toggleMinimize);

function toggleMinimize() {
  const isMinimized = box.classList.toggle("minimized");
  if (isMinimized) {
    box.style.height = HEADER_HEIGHT + "px";
    box.style.width = "200px";
    headerButton.textContent = "+";
  } else {
    updateWidgetHeight();
    headerButton.textContent = "-";
  }
  localStorage.setItem("staffWidgetMinimized", isMinimized);
}

// Simulate staff
simBtn.addEventListener("click", () => {
  simActive = !simActive;
  simStaffCount = simActive ? Math.floor(Math.random() * 20) + 1 : 0;
  fetchStaff();
});

// Restore minimized state on load
window.addEventListener("DOMContentLoaded", () => {
  if (localStorage.getItem("staffWidgetMinimized") === "true") {
    toggleMinimize();
  }
  fetchStaff();
  setInterval(fetchStaff, 10000); // refresh every 10s
});

// Fetch real staff
async function fetchStaff() {
  try {
    const res = await fetch(serverUrlBase);
    const data = await res.json();

    // Filter real staff
    const realStaff = (data.players || []).filter(p => Array.isArray(p) && p[4] === true);

    // Simulated staff
    const simStaff = [];
    for (let i = 0; i < simStaffCount; i++) {
      simStaff.push({
        name: "SimStaff" + (i+1),
        job: "Job",
        avatar: "https://via.placeholder.com/30",
      });
    }

    const allStaff = [...realStaff.map(p => ({
      name: p[0],
      job: p[5],
      avatar: p[3] || "https://via.placeholder.com/30"
    })), ...simStaff];

    if (allStaff.length === 0) {
      staffListEl.innerHTML = "No staff online";
      box.style.height = HEADER_HEIGHT + PADDING + "px";
      document.getElementById("headerTitle").textContent = "Online Staff (0)";
      document.getElementById("headerTitle").style.color = "red";
    } else {
      staffListEl.innerHTML = allStaff.map(p => `
        <div>
          <img src="${p.avatar}" alt="avatar">
          <span class="name">${p.name}</span>
          <span class="job">${p.job}</span>
        </div>
      `).join("");

      const staffCount = allStaff.length;
      const newHeight = HEADER_HEIGHT + staffCount * ROW_HEIGHT + PADDING;
      const maxHeight = window.innerHeight - 50;
      const minHeight = 100;
      if (!box.classList.contains("minimized")) {
        box.style.height = Math.max(minHeight, Math.min(newHeight, maxHeight)) + "px";
      }
      document.getElementById("headerTitle").textContent = `Online Staff (${staffCount})`;
      document.getElementById("headerTitle").style.color = "limegreen";
    }
  } catch(err) {
    staffListEl.innerHTML = "Error fetching staff";
    console.error(err);
    document.getElementById("headerTitle").textContent = "Online Staff (?)";
    document.getElementById("headerTitle").style.color = "orange";
  }
}

function updateWidgetHeight() {
  const staffCount = staffListEl.children.length;
  const newHeight = HEADER_HEIGHT + staffCount * ROW_HEIGHT + PADDING;
  const maxHeight = window.innerHeight - 50;
  const minHeight = 100;
  box.style.height = Math.max(minHeight, Math.min(newHeight, maxHeight)) + "px";
}
</script>

</body>
</html>
