<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transport Tycoon Staff Widget</title>
  <style>
    /* Styling for the widget */
    #staffWidget {
      position: absolute;
      top: 50px;
      left: 50px;
      width: 300px;
      min-width: 150px;
      max-width: 600px;
      height: 100px;
      background: #1e1e1e;
      color: white;
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      user-select: none;
      resize: both;
      z-index: 9999;
    }

    #staffHeader {
      background: #333;
      padding: 5px 10px;
      cursor: move;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: normal;
    }

    #staffList {
      padding: 5px 10px;
      overflow-y: auto;
    }

    .staffRow {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .staffRow img {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .staffRow div div:first-child {
      font-weight: bold;
    }

    .staffRow div div:last-child {
      font-weight: normal;
      color: #ccc;
      font-size: 0.8em;
    }

    #buttonContainer {
      margin-left: 10px;
    }

    .controlBtn {
      background: #555;
      border: none;
      color: white;
      padding: 2px 6px;
      margin-left: 5px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
  </style>
</head>
<body>

<div id="staffWidget">
  <div id="staffHeader">
    <span id="headerTitle">Online Staff (0)</span>
    <div id="buttonContainer">
      <button id="toggleBtn" class="controlBtn">−</button>
      <button id="simBtn" class="controlBtn">Sim</button>
    </div>
  </div>
  <div id="staffList"></div>
</div>

<script>
const box = document.getElementById("staffWidget");
const header = document.getElementById("staffHeader");
const staffListEl = document.getElementById("staffList");
const headerTitle = document.getElementById("headerTitle");
const toggleBtn = document.getElementById("toggleBtn");
const simBtn = document.getElementById("simBtn");

let minimized = false;
let dragOffsetX = 0;
let dragOffsetY = 0;
let dragging = false;
let resizing = false;
let simActive = false;

const HEADER_HEIGHT = 35;
const PADDING = 10;
const ROW_HEIGHT = 30;
const SERVER_URL = 'https://tycoon-2epova.users.cfx.re/status/widget/players.json';

header.addEventListener("mousedown", e => {
  dragging = true;
  dragOffsetX = e.clientX - box.offsetLeft;
  dragOffsetY = e.clientY - box.offsetTop;
});

document.addEventListener("mouseup", () => dragging = false);
document.addEventListener("mousemove", e => {
  if (dragging && !resizing) {
    box.style.left = (e.clientX - dragOffsetX) + "px";
    box.style.top = (e.clientY - dragOffsetY) + "px";
  }
});

box.addEventListener("mousedown", e => {
  if (e.offsetX > box.clientWidth - 15 && e.offsetY > box.clientHeight - 15) {
    resizing = true;
  }
});
document.addEventListener("mouseup", () => resizing = false);

toggleBtn.addEventListener("click", () => {
  minimized = !minimized;
  if (minimized) {
    box.style.height = HEADER_HEIGHT + "px";
    box.style.width = "150px";
    toggleBtn.textContent = "+";
    staffListEl.style.overflowY = "hidden";
  } else {
    updateStaffHeightAndWidth();
    toggleBtn.textContent = "−";
    staffListEl.style.overflowY = "auto";
  }
});

simBtn.addEventListener("click", () => {
  simActive = !simActive;
  if (simActive) {
    const fakeStaff = Array.from({ length: Math.floor(Math.random() * 10) + 1 }, (_, i) => [
      `SimStaff${i+1}`,
      i,
      i+1000,
      `https://i.pravatar.cc/24?img=${i+1}`,
      true,
      ["Cargo Pilot", "Bus Driver", "EMS / Paramedic", "Trucker", "R.T.S. Transporter"][i % 5],
      false
    ]);
    displayStaff(fakeStaff);
  } else {
    fetchRealStaff();
  }
});

async function fetchRealStaff() {
  try {
    const res = await fetch(SERVER_URL);
    const data = await res.json();

    const realStaff = data.players.filter(p => p[4] === true);

    displayStaff(realStaff);
  } catch (err) {
    staffListEl.innerHTML = "Error fetching staff";
    console.error(err);
  }
}

function displayStaff(staffMembers) {
  if (staffMembers.length === 0) {
    staffListEl.innerHTML = "No staff online";
    headerTitle.textContent = "Online Staff (0)";
    headerTitle.style.color = "red";
    box.style.height = minimized ? HEADER_HEIGHT + "px" : HEADER_HEIGHT + PADDING + "px";
    if (!minimized) box.style.width = "150px";
  } else {
    staffListEl.innerHTML = staffMembers.map(p => `
      <div class="staffRow">
        <img src="${p[3] || 'https://via.placeholder.com/24'}">
        <div>
          <div>${p[0]}</div>
          <div>${p[5]}</div>
        </div>
      </div>
    `).join("");

    headerTitle.textContent = `Online Staff (${staffMembers.length})`;
    headerTitle.style.color = "limegreen";
    if (!minimized) updateStaffHeightAndWidth();
  }
}

function updateStaffHeightAndWidth() {
  const count = staffListEl.children.length;

  let maxTextWidth = 0;
  const tempDiv = document.createElement("div");
  tempDiv.style.position = "absolute";
  tempDiv.style.visibility = "hidden";
  tempDiv.style.whiteSpace = "nowrap";
  document.body.appendChild(tempDiv);

  staffListEl.querySelectorAll(".staffRow").forEach(row => {
    const name = row.querySelector("div div:first-child").textContent;
    const job = row.querySelector("div div:last-child").textContent;
    tempDiv.style.fontWeight = "bold";
    tempDiv.textContent = name;
    const nameWidth = tempDiv.offsetWidth;
    tempDiv.style.fontWeight = "normal";
    tempDiv.textContent = job;
    const jobWidth = tempDiv.offsetWidth;
    const total = nameWidth + jobWidth + 40;
    if (total > maxTextWidth) maxTextWidth = total;
  });

  document.body.removeChild(tempDiv);

  const newWidth = Math.min(Math.max(maxTextWidth + PADDING*2, 150), 600); 
  box.style.width = minimized ? "150px" : newWidth + "px";

  let newHeight = HEADER_HEIGHT + count * ROW_HEIGHT + PADDING;
  const maxHeight = window.innerHeight - 50;
  const minHeight = 100;
  box.style.height = minimized ? HEADER_HEIGHT + "px" : Math.min(newHeight, maxHeight) + "px";

  staffListEl.style.overflowY = newHeight > maxHeight ? "auto" : "hidden";
}

// Initial fetch
fetchRealStaff();
</script>

</body>
</html>
