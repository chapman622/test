<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Staff Widget</title>
<style>
#staffWidget {
    position: fixed;
    top: 50px;
    left: 50px;
    width: 250px;
    height: 200px;
    background: #222;
    color: white;
    font-family: sans-serif;
    border: 1px solid #444;
    user-select: none;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    resize: both;
    overflow: hidden;
}
#staffWidgetHeader {
    background: #333;
    padding: 5px;
    cursor: move;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#staffWidgetHeader span {
    font-weight: bold;
}
#staffList {
    padding: 5px;
    overflow-y: auto;
    flex: 1;
}
.staff-member {
    display: flex;
    align-items: center;
    margin-bottom: 3px;
}
.staff-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    margin-right: 5px;
}
.staff-info {
    display: flex;
    flex-direction: column;
    font-size: 12px;
}
button {
    background: #444;
    border: none;
    color: white;
    padding: 2px 6px;
    cursor: pointer;
}
</style>
</head>
<body>

<div id="staffWidget">
    <div id="staffWidgetHeader">
        <span id="headerTitle">Online Staff (0)</span>
        <div>
            <button id="simBtn">Sim</button>
            <button id="minMaxBtn">–</button>
        </div>
    </div>
    <div id="staffList"></div>
</div>

<script>
const serverUrlBase = "https://tycoon-2epova.users.cfx.re/status/widget/players.json";
const staffListEl = document.getElementById("staffList");
const headerTitle = document.getElementById("headerTitle");
const box = document.getElementById("staffWidget");
const simBtn = document.getElementById("simBtn");
const minMaxBtn = document.getElementById("minMaxBtn");

let simEnabled = false;
let minimized = false;

// Load persisted position & size
const storedPos = JSON.parse(localStorage.getItem("staffWidgetPos")) || {};
const storedSize = JSON.parse(localStorage.getItem("staffWidgetSize")) || {};
if(storedPos.top) box.style.top = storedPos.top;
if(storedPos.left) box.style.left = storedPos.left;
if(storedSize.width) box.style.width = storedSize.width;
if(storedSize.height) box.style.height = storedSize.height;

simBtn.addEventListener("click", () => {
    simEnabled = !simEnabled;
    simBtn.textContent = simEnabled ? "Sim ON" : "Sim";
    fetchStaff();
});

minMaxBtn.addEventListener("click", () => {
    minimized = !minimized;
    staffListEl.style.display = minimized ? "none" : "block";
    minMaxBtn.textContent = minimized ? "+" : "–";
});

async function fetchStaff() {
    try {
        const res = await fetch(serverUrlBase);
        let data = await res.json();

        if(simEnabled){
            const simCount = Math.floor(Math.random() * 10) + 1;
            data.players = [];
            for(let i=0;i<simCount;i++){
                data.players.push([`Sim${i+1}`, i, 1000+i, "", true, "Job", false]);
            }
        }

        const staffMembers = (data.players || []).filter(p => Array.isArray(p) && p[4] === true);

        if(staffMembers.length === 0){
            staffListEl.innerHTML = "No staff online";
            headerTitle.textContent = "Online Staff (0)";
            headerTitle.style.color = "red";
        } else {
            staffListEl.innerHTML = staffMembers.map(p => `
                <div class="staff-member">
                    <img class="staff-avatar" src="${p[3] || 'https://via.placeholder.com/24'}">
                    <div class="staff-info">
                        <span>${p[0]}</span>
                        <span>${p[5]}</span>
                    </div>
                </div>
            `).join("");

            headerTitle.textContent = `Online Staff (${staffMembers.length})`;
            headerTitle.style.color = "limegreen";

            // Auto width based on longest name
            const maxNameLength = Math.max(...staffMembers.map(p => p[0].length));
            box.style.width = Math.max(200, maxNameLength * 10) + "px";
        }
    } catch(err) {
        staffListEl.innerHTML = "Error fetching staff";
        headerTitle.textContent = "Online Staff (?)";
        headerTitle.style.color = "orange";
        console.error(err);
    }
}

// Drag from anywhere
let offsetX, offsetY, isDragging = false;
box.addEventListener("mousedown", e => {
    if(e.target === minMaxBtn || e.target === simBtn) return;
    isDragging = true;
    offsetX = e.clientX - box.offsetLeft;
    offsetY = e.clientY - box.offsetTop;
});
document.addEventListener("mousemove", e => {
    if(isDragging){
        box.style.left = (e.clientX - offsetX) + "px";
        box.style.top = (e.clientY - offsetY) + "px";
    }
});
document.addEventListener("mouseup", () => {
    if(isDragging){
        localStorage.setItem("staffWidgetPos", JSON.stringify({top: box.style.top, left: box.style.left}));
    }
    isDragging = false;
});

// Save size after resize
box.addEventListener("mouseup", () => {
    localStorage.setItem("staffWidgetSize", JSON.stringify({width: box.style.width, height: box.style.height}));
});

// Auto refresh every 10 seconds
setInterval(fetchStaff, 10000);
fetchStaff();
</script>

</body>
</html>
